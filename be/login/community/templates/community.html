<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>커뮤니티</title>
  <style>
    .card-list { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    .card-item {
      border: 2px solid #ccc; padding: 5px; cursor: pointer; width: 110px; text-align: center; background: #fafafa;
      transition: border 0.2s;
    }
    .card-item.selected { border: 2px solid #007bff; background: #eaf4ff; }
    .card-item img { width: 100px; height: 100px; object-fit: cover; }
    .card-label { font-size: 11px; color: #555; }
  </style>
</head>
<body>
  <h2>커뮤니티</h2>
  <form id="postForm" enctype="multipart/form-data">
    <textarea id="content" rows="3" cols="40" placeholder="글을 작성하세요"></textarea><br>
    <input type="file" id="image" accept="image/*"><br>

    <div>
      <b>옷 첨부:</b>
      <button type="button" id="toggleClosetBtn" style="margin-left:8px;">▼ 펼치기</button>
      <input type="text" id="closetSearch" placeholder="옷 검색" style="margin-left:8px; width:120px; display:none;">
      <div id="closetList" class="card-list" style="display: none;"></div>
    </div>

    <div>
      <b>추천코디 첨부:</b>
      <button type="button" id="toggleRecoBtn" style="margin-left:8px;">▼ 펼치기</button>
      <input type="text" id="recoSearch" placeholder="코디 검색" style="margin-left:8px; width:120px; display:none;">
      <div id="recoList" class="card-list" style="display:none;"></div>
    </div>

    <input type="hidden" id="selectedClosetIdx">
    <input type="hidden" id="selectedRecoIdx">
    <br>
    <button type="submit">글 작성</button>
  </form>
  <hr>
  <div id="posts"></div>

  <script>
    let myUid = null;
    let closetList = [];
    let recoList = [];
    let recoListFiltered = [];

    async function fetchMyUid() {
      const jwt = localStorage.getItem('jwt');
      if (!jwt) return null;
      try {
        const res = await fetch('/auth/verify_token', {
          headers: { 'Authorization': 'Bearer ' + jwt }
        });
        if (res.ok) {
          const data = await res.json();
          return data.email || null;
        }
      } catch {}
      return null;
    }

    async function fetchClosetAndReco() {
      const jwt = localStorage.getItem('jwt');
      if (!jwt) return;

      const closetRes = await fetch('/upload/my_closet', {
        headers: { 'Authorization': 'Bearer ' + jwt }
      });
      const closetData = await closetRes.json();
      closetList = closetData.images || [];
      console.log('✅ closetList:', closetList);
      renderClosetList();

      const recoRes = await fetch('/api/history/recommendations/all', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + jwt, 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const recoData = await recoRes.json();
      recoList = recoData.recommendations || [];
      recoListFiltered = [];
      renderRecoList();
    }

    function renderClosetList() {
      const container = document.getElementById('closetList');
      container.innerHTML = closetList.map((item, idx) => `
        <div class="card-item" id="closetCard${idx}" onclick="selectCloset(${idx})">
          ${item.url ? `<img src="${item.url}"><br>` : ''}
          <span>${item.category || ''}</span><br>
          <span class="card-label">${item.filename || ''}</span>
        </div>
      `).join('');
    }

    window.selectCloset = function(idx) {
      document.getElementById('selectedClosetIdx').value = idx;
      closetList.forEach((_, i) => {
        document.getElementById('closetCard'+i)?.classList.toggle('selected', i==idx);
      });
    };

    function renderRecoList() {
      const container = document.getElementById('recoList');
      const list = recoListFiltered.length ? recoListFiltered : recoList;
      container.innerHTML = list.map((r, idx) => {
        let reco = r.recommended?.recommended || r.recommended || r;
        if (typeof reco === 'string') {
          try { reco = JSON.parse(reco); } catch {}
        }
        let thumb = reco.top?.url ? `<img src="${reco.top.url}"><br>` : '';
        const realIdx = recoList.indexOf(r);
        return `
          <div class="card-item" id="recoCard${realIdx}" onclick="selectReco(${realIdx})">
            ${thumb}
            <span>${r.id}</span>
          </div>
        `;
      }).join('');
    }

    window.selectReco = function(idx) {
      document.getElementById('selectedRecoIdx').value = idx;
      recoList.forEach((_, i) => {
        document.getElementById('recoCard'+i)?.classList.toggle('selected', i==idx);
      });
    };

    document.getElementById('recoSearch').addEventListener('input', function() {
      const q = this.value.trim();
      if (!q) {
        recoListFiltered = [];
      } else {
        recoListFiltered = recoList.filter(r =>
          (r.id && r.id.includes(q)) ||
          (JSON.stringify(r.recommended || r).includes(q))
        );
      }
      renderRecoList();
    });

    document.getElementById('toggleRecoBtn').addEventListener('click', function() {
      const list = document.getElementById('recoList');
      const search = document.getElementById('recoSearch');
      if (list.style.display === 'none') {
        list.style.display = 'flex';
        search.style.display = '';
        this.textContent = '▲ 접기';
        renderRecoList();
      } else {
        list.style.display = 'none';
        search.style.display = 'none';
        this.textContent = '▼ 펼치기';
      }
    });

    document.getElementById('toggleClosetBtn').addEventListener('click', function() {
      const list = document.getElementById('closetList');
      const search = document.getElementById('closetSearch');
      if (list.style.display === 'none') {
        list.style.display = 'flex';
        search.style.display = '';
        this.textContent = '▲ 접기';
        renderClosetList();
      } else {
        list.style.display = 'none';
        search.style.display = 'none';
        this.textContent = '▼ 펼치기';
      }
    });

    async function fetchPosts() {
      if (!myUid) myUid = await fetchMyUid();
      const res = await fetch('/community/posts');
      const posts = await res.json();
      document.getElementById('posts').innerHTML = posts.map(p => {
        let btns = '';
        if (myUid && (p.user_id === myUid)) {
          btns = `
            <button onclick="editPostPrompt('${p.id}', '${encodeURIComponent(p.content)}')">수정</button>
            <button onclick="deletePost('${p.id}')">삭제</button>
          `;
        }
        let imgHtml = p.image_url ? `<br><img src="${p.image_url}" style="max-width:200px;">` : '';
        let closetHtml = '';
        if (p.closet_item) {
          closetHtml = `<div>첨부 옷: ${p.closet_item.category || ''} ${p.closet_item.filename || ''}`;
          if (p.closet_item.url) closetHtml += `<br><img src="${p.closet_item.url}" style="max-width:120px;">`;
          closetHtml += '</div>';
        }
        let recoHtml = '';
        if (p.reco_item) {
          let reco = p.reco_item.recommended?.recommended || p.reco_item.recommended || p.reco_item;
          if (typeof reco === 'string') {
            try { reco = JSON.parse(reco); } catch {}
          }
          recoHtml = `<div>첨부 추천코디:<br>${renderRecommended(reco)}</div>`;
        }
        return `<div style="border:1px solid #ccc;margin:8px;padding:8px;">
                  <b>${p.nickname || p.user_id}</b> <small>${p.created_at || ''}</small><br>
                  <span id="content-${p.id}">${p.content}</span>
                  ${imgHtml}<br>${closetHtml}${recoHtml}${btns}
                </div>`;
      }).join('');
    }

    function renderRecommended(rec) {
      if (!rec) return '';
      let html = '<ul>';
      for (const key of ['top', 'bottom', 'outer']) {
        if (rec[key]) {
          html += `<li><b>${key}:</b> `;
          if (typeof rec[key] === 'object' && rec[key] !== null && rec[key].url) {
            html += `${rec[key].category || ''} (${rec[key].filename || ''})<br>`;
            html += `<img src="${rec[key].url}" width="80" style="margin:2px 0;">`;
          } else {
            html += JSON.stringify(rec[key]);
          }
          html += '</li>';
        }
      }
      html += '</ul>';
      return html;
    }

    async function deletePost(postId) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      const jwt = localStorage.getItem('jwt');
      const res = await fetch(`/community/posts/${postId}`, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + jwt }
      });
      if (res.ok) {
        alert('삭제되었습니다.');
        fetchPosts();
      } else {
        alert('삭제 실패');
      }
    }

    function editPostPrompt(postId, content) {
      const newContent = prompt('수정할 내용을 입력하세요:', decodeURIComponent(content));
      if (newContent !== null) editPost(postId, newContent);
    }

    async function editPost(postId, content) {
      const jwt = localStorage.getItem('jwt');
      const res = await fetch(`/community/posts/${postId}`, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + jwt,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content })
      });
      if (res.ok) {
        alert('수정되었습니다.');
        fetchPosts();
      } else {
        alert('수정 실패');
      }
    }

    document.getElementById('postForm').onsubmit = async e => {
      e.preventDefault();
      const jwt = localStorage.getItem('jwt');
      const content = document.getElementById('content').value;
      const imageInput = document.getElementById('image');
      const closetIdx = document.getElementById('selectedClosetIdx').value;
      const recoIdx = document.getElementById('selectedRecoIdx').value;
      if (!jwt) return alert('로그인 필요');
      if (!content.trim()) return alert('내용을 입력하세요.');

      let imageUrl = '';
      if (imageInput.files.length > 0) {
        const formData = new FormData();
        formData.append('image', imageInput.files[0]);
        const res = await fetch('/community/upload_image', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + jwt },
          body: formData
        });
        if (res.ok) {
          const data = await res.json();
          imageUrl = data.url;
        } else {
          alert('이미지 업로드 실패');
          return;
        }
      }

      const closetItem = closetIdx ? closetList[closetIdx] : null;
      const recoItem = recoIdx ? recoList[recoIdx] : null;

      const res = await fetch('/community/posts', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + jwt,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content, image_url: imageUrl, closet_item: closetItem, reco_item: recoItem })
      });
      if (res.ok) {
        document.getElementById('content').value = '';
        imageInput.value = '';
        document.getElementById('selectedClosetIdx').value = '';
        document.getElementById('selectedRecoIdx').value = '';
        closetList.forEach((_, i) => document.getElementById('closetCard'+i)?.classList.remove('selected'));
        recoList.forEach((_, i) => document.getElementById('recoCard'+i)?.classList.remove('selected'));
        fetchPosts();
      } else {
        alert('글 작성 실패');
      }
    };

    window.onload = async () => {
      myUid = await fetchMyUid();
      await fetchClosetAndReco();
      fetchPosts();
    };
  </script>
</body>
</html>
