<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>내 이미지 보기</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; margin: 40px; }
        h2 { margin-bottom: 20px; }
        .image-card {
            display: inline-block;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin: 10px;
            text-align: center;
            background: #fafafa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            vertical-align: top;
        }
        .image-card img { width: 150px; height: 150px; object-fit: cover; border-radius: 4px; }
        .image-meta { font-size: 13px; color: #555; margin: 8px 0; }
        .delete-btn, .edit-btn {
            background: #e74c3c; color: #fff; border: none; border-radius: 4px;
            padding: 6px 12px; cursor: pointer; margin-top: 8px;
        }
        .edit-btn { background: #3498db; margin-left: 6px; }
        .edit-btn:hover { background: #217dbb; }
        .delete-btn:hover { background: #c0392b; }
        .edit-form { margin-top: 8px; font-size: 13px; background: #f4f8fb; padding: 8px; border-radius: 6px; }
    </style>
</head>
<body>
    <h2>내 이미지 목록</h2>
    <div id="imageList"></div>
    <script>
        const categories = [
            'blazer', 'cardigan', 'coat', 'cotton pants', 'denim', 'dress', 'hood',
            'longpedding', 'longsleeve', 'shirt', 'shortpedding', 'shorts',
            'shortsleeve', 'skirt', 'slacks', 'sleeveless', 'sweater', 'trainingpants',
            'hoodzip', 'fleece', 'jumper'
        ];
        const colors = [
            'Beige', 'Black', 'Blue', 'Brown', 'Gray', 'Green', 'Orange',
            'Pink', 'Purple', 'Red', 'White', 'Yellow'
        ];
        const materials = [
            '면','데님','니트','린넨/마','가죽','퍼/털','시폰/얇은 원단','실크/새틴',
            '스판덱스/신축성 스포츠 원단','나일론/ 방수원단','울/정장소재','니트/스웨터소재',
            '벨벳','트위드'
        ];

        let editOpenId = null;

        async function loadImages() {
            const jwt = localStorage.getItem('jwt');
            const res = await fetch('/upload/my_images', {
                headers: { 'Authorization': 'Bearer ' + jwt }
            });
            const data = await res.json();
            const container = document.getElementById('imageList');
            container.innerHTML = '';
            if (!data.images || data.images.length === 0) {
                container.innerHTML = '<p>등록된 이미지가 없습니다.</p>';
                return;
            }
            data.images.forEach(img => {
                const div = document.createElement('div');
                div.className = 'image-card';
                div.innerHTML = `
                    <img src="${img.url}" alt="내 이미지" /><br/>
                    <div class="image-meta">
                        <strong>의류 종류:</strong> ${img.clothing_type || '-'}<br/>
                        <strong>소재:</strong> ${img.material || '-'}<br/>
                        <strong>색상:</strong> ${(img.colors || []).join(', ')}<br/>
                        <strong>업로드 시간:</strong> ${img.uploaded_at || '-'}
                    </div>
                    <button class="delete-btn" onclick="deleteImage('${img.id}')">삭제</button>
                    <button class="edit-btn" onclick="openEditForm('${img.id}', '${img.clothing_type || ''}', '${img.material || ''}', ${JSON.stringify(img.colors || [])})">수정</button>
                    <div id="editForm-${img.id}" style="display:none;"></div>
                `;
                container.appendChild(div);
            });
        }

        function openEditForm(imageId, clothing_type, material, colorsSelected=[]) {
            if (editOpenId && editOpenId !== imageId) {
                document.getElementById('editForm-' + editOpenId).style.display = 'none';
            }
            editOpenId = imageId;
            const formDiv = document.getElementById('editForm-' + imageId);
            formDiv.style.display = '';

            const colorCheckboxes = colors.map(c =>
                `<label><input type="checkbox" name="colors" value="${c}" ${colorsSelected.includes(c)?'checked':''}/> ${c}</label><br/>`
            ).join("");

            formDiv.innerHTML = `
                <form class="edit-form" onsubmit="submitEdit(event, '${imageId}')">
                    <label>의류 종류:
                        <select name="clothing_type">
                            ${categories.map(c => `<option value="${c}" ${c===clothing_type?'selected':''}>${c}</option>`).join("")}
                        </select>
                    </label><br/><br/>
                    <label>소재:
                        <select name="material">
                            ${materials.map(m => `<option value="${m}" ${m===material?'selected':''}>${m}</option>`).join("")}
                        </select>
                    </label><br/><br/>
                    <div><strong>색상:</strong><br/>${colorCheckboxes}</div><br/>
                    <button type="submit">저장</button>
                    <button type="button" onclick="closeEditForm('${imageId}')">취소</button>
                </form>
            `;
        }

        function closeEditForm(imageId) {
            document.getElementById('editForm-' + imageId).style.display = 'none';
            editOpenId = null;
        }

        async function submitEdit(e, imageId) {
            e.preventDefault();
            const jwt = localStorage.getItem('jwt');
            const form = e.target;
            const clothing_type = form.clothing_type.value;
            const material = form.material.value;
            const colorsSelected = Array.from(form.querySelectorAll('input[name="colors"]:checked'))
                                        .map(cb => cb.value);
            const payload = { clothing_type, material, colors: colorsSelected };

            const res = await fetch(`/upload/edit_image/${imageId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + jwt,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                alert('수정 성공!');
                closeEditForm(imageId);
                loadImages();
            } else {
                const error = await res.json();
                alert('수정 실패: ' + (error.error || '알 수 없는 오류'));
            }
        }

        async function deleteImage(imageId) {
            const jwt = localStorage.getItem('jwt');
            if (!confirm('정말 삭제하시겠습니까?')) return;
            const res = await fetch(`/upload/delete_image/${imageId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + jwt }
            });
            if (res.ok) {
                alert('삭제 성공!');
                loadImages();
            } else {
                const error = await res.json();
                alert('삭제 실패: ' + (error.error || '알 수 없는 오류'));
            }
        }

        window.onload = () => { loadImages(); }
    </script>
</body>
</html>
