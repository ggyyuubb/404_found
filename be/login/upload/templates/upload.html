<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>이미지 업로드</title>
</head>
<body>
    <h1>Firebase Storage에 이미지 업로드</h1>
    <form id="uploadForm">
        <input type="file" id="image" name="image" required /><br /><br />
        <button type="submit">업로드</button>
    </form>

    <div id="result" style="margin-top: 20px;"></div>
    <div id="editSection" style="display:none; margin-top:20px;">
        <h3>AI 분석 결과 (수정 가능)</h3>
        <form id="editForm">
            <label>의류 종류:
                <select id="clothing_type" name="clothing_type"></select>
            </label><br/><br/>
            <label>소재:
                <select id="material" name="material"></select>
            </label><br/><br/>
            <div>
                <strong>색상:</strong><br/>
                <div id="colorOptions"></div>
            </div><br/>
            <button type="submit">수정 후 저장</button>
        </form>
    </div>

    <script>
        const categories = [
            'blazer', 'cardigan', 'coat', 'cotton pants', 'denim', 'dress', 'hood',
            'longpedding', 'longsleeve', 'shirt', 'shortpedding', 'shorts',
            'shortsleeve', 'skirt', 'slacks', 'sleeveless', 'sweater', 'trainingpants',
            'hoodzip', 'fleece', 'jumper'
        ];
        const colors = [
            'Beige', 'Black', 'Blue', 'Brown', 'Gray', 'Green', 'Orange',
            'Pink', 'Purple', 'Red', 'White', 'Yellow'
        ];
        const materials = [
            '면','데님','니트','린넨/마','가죽','퍼/털','시폰/얇은 원단','실크/새틴',
            '스판덱스/신축성 스포츠 원단','나일론/ 방수원단','울/정장소재','니트/스웨터소재',
            '벨벳','트위드'
        ];

        let lastImageId = null;

        function populateOptions(selectedCategory, selectedMaterial, selectedColors) {
            const clothingSelect = document.getElementById("clothing_type");
            clothingSelect.innerHTML = categories.map(c =>
                `<option value="${c}" ${c===selectedCategory ? 'selected':''}>${c}</option>`
            ).join("");

            const materialSelect = document.getElementById("material");
            materialSelect.innerHTML = materials.map(m =>
                `<option value="${m}" ${m===selectedMaterial ? 'selected':''}>${m}</option>`
            ).join("");

            const colorOptions = document.getElementById("colorOptions");
            colorOptions.innerHTML = colors.map(c =>
                `<label><input type="checkbox" name="colors" value="${c}" ${selectedColors.includes(c)?'checked':''}/> ${c}</label><br/>`
            ).join("");
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const jwt = localStorage.getItem('jwt');
            if (!jwt) {
                alert('로그인이 필요합니다.');
                return;
            }

            const image = document.getElementById('image').files[0];
            const formData = new FormData();
            formData.append('image', image);

            const response = await fetch('/upload/', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + jwt },
                body: formData
            });

            const result = await response.json();
            const resultDiv = document.getElementById('result');
            if (response.ok) {
                resultDiv.innerHTML = `<p>${result.message}</p><a href="${result.url}" target="_blank">이미지 보기</a>`;

                if (result.ai_result) {
                    populateOptions(
                        result.ai_result.clothing_type || '',
                        result.ai_result.material || '',
                        result.ai_result.colors || []
                    );
                    document.getElementById('editSection').style.display = 'block';
                }
                lastImageId = result.id;
            } else {
                resultDiv.innerHTML = `<p style="color: red;">${result.error || '업로드 실패'}</p>`;
            }
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!lastImageId) {
                alert('수정할 이미지 ID를 찾을 수 없습니다.');
                return;
            }
            const jwt = localStorage.getItem('jwt');
            const clothing_type = document.getElementById('clothing_type').value;
            const material = document.getElementById('material').value;
            const colorsSelected = Array.from(document.querySelectorAll('input[name="colors"]:checked'))
                                        .map(cb => cb.value);

            const payload = { clothing_type, material, colors: colorsSelected };

            const res = await fetch(`/upload/edit_image/${lastImageId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + jwt,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('수정 성공!');
            } else {
                const error = await res.json();
                alert('수정 실패: ' + (error.error || '알 수 없는 오류'));
            }
        });
    </script>
</body>
</html>
